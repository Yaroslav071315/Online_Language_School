@model Online_Language_School.ViewModels.AdminOfficeViewModel

@{
    ViewData["Title"] = "Administrator Office";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid">
    <div class="row">
        <!-- Ліва панель -->
        <nav class="col-2 bg-light border-end"
             style="position:fixed; top:0; left:0; height:100vh; overflow-y:auto; padding:20px;">
            <h5>Menu</h5>
            <ul class="nav flex-column nav-pills">
                <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#users">Users</a></li>
                <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#courses">Courses</a></li>
                <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#news">News</a></li>
                <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#payments">Payments</a></li>
                <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#enrollments">Enrollments</a></li>
                <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#refunds">Refunds</a></li>
                <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#chat">Chat</a></li>
            </ul>
            <hr />
            <footer class="small text-center">
                <p>📞 info@languageschool.com | +380 67 123 4567</p>
                <p>🌐 <a href="#">Facebook</a> | <a href="#">Instagram</a> | <a href="#">LinkedIn</a></p>
            </footer>
        </nav>

        <!-- Центральна частина -->
        <main class="col-10 offset-2 p-4">
            <h2 class="mb-4">⚙️ Administrator Office</h2>

            <!-- Вкладки -->
            <ul class="nav nav-tabs" id="adminTabs" role="tablist">
                <li class="nav-item">
                    <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button">👥 Users</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="courses-tab" data-bs-toggle="tab" data-bs-target="#courses" type="button">📚 Courses</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="news-tab" data-bs-toggle="tab" data-bs-target="#news" type="button">📰 News</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="payments-tab" data-bs-toggle="tab" data-bs-target="#payments" type="button">💳 Payments</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="enrollments-tab" data-bs-toggle="tab" data-bs-target="#enrollments" type="button">📝 Enrollments</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="refunds-tab" data-bs-toggle="tab" data-bs-target="#refunds" type="button">💳 Refunds</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="chat-tab" data-bs-toggle="tab" data-bs-target="#chat" type="button">💬 Chat</button>
                </li>
            </ul>

            <!-- Контент вкладок -->
            <div class="tab-content mt-3">
                <div class="tab-pane fade show active" id="users" role="tabpanel">
                    <div id="usersContent">Loading...</div>
                </div>
                <div class="tab-pane fade" id="courses" role="tabpanel">
                    <div id="coursesContent">Loading...</div>
                </div>
                <div class="tab-pane fade" id="news" role="tabpanel">
                    <div id="newsContent">Loading...</div>
                </div>
                <div class="tab-pane fade" id="payments" role="tabpanel">
                    <div id="paymentsContent">Loading...</div>
                </div>
                <div class="tab-pane fade" id="enrollments" role="tabpanel">
                    <div id="enrollmentsContent">Loading...</div>
                </div>
                <div class="tab-pane fade" id="refunds" role="tabpanel">
                    <div id="refundsContent">Loading...</div>
                </div>
                <div class="tab-pane fade" id="chat" role="tabpanel">
                    <div id="chatContent">Loading...</div>
                </div>
            </div>
        </main>
    </div>
</div>

@section Scripts {
        <script>
            function loadTabContent(tabId, url) {
                fetch(url)
                    .then(response => response.text())
                    .then(html => {
                        document.getElementById(tabId).innerHTML = html;
                    });
            }

            // Завантажуємо Users при старті
            loadTabContent("usersContent", "/Administrator/Users");

            // Підвантаження при кліку на вкладки
            document.getElementById("users-tab").addEventListener("click", () => {
                loadTabContent("usersContent", "/Administrator/Users");
            });
            document.getElementById("courses-tab").addEventListener("click", () => {
                loadTabContent("coursesContent", "/Administrator/Courses");
            });
            document.getElementById("news-tab").addEventListener("click", () => {
                loadTabContent("newsContent", "/Administrator/News");
            });
            document.getElementById("payments-tab").addEventListener("click", () => {
                loadTabContent("paymentsContent", "/Administrator/Payments");
            });
            document.getElementById("enrollments-tab").addEventListener("click", () => {
                loadTabContent("enrollmentsContent", "/Administrator/Enrollments");
            });
            document.getElementById("refunds-tab").addEventListener("click", () => {
                loadTabContent("refundsContent", "/Administrator/Refunds");
            });
            document.getElementById("chat-tab").addEventListener("click", () => {
                loadTabContent("chatContent", "/Chat/Index");
            });
            document.addEventListener("click", function(e) {
                // якщо клік по accordion‑кнопці — нічого не робимо
                if (e.target.closest(".accordion-button")) {
                    return;
                }

                const chatLink = e.target.closest("a[data-chat]");
                const materialsLink = e.target.closest("a[view-courses]");

                if (chatLink) {
                    e.preventDefault();
                    const url = chatLink.getAttribute("href");
                    loadTabContent("chatContent", url);
                }

                if (materialsLink) {
                    e.preventDefault();
                    const url = materialsLink.getAttribute("href");
                    loadTabContent("coursesContent", url);
                }
            });

            document.addEventListener("submit", function(e) {
                const form = e.target;
                e.preventDefault();

                const handleFetch = (contentId) => {
                    const formData = new FormData(form);
                    fetch(form.action, { method: "POST", body: formData })
                        .then(res => res.text())
                        .then(html => {
                            document.getElementById(contentId).innerHTML = html;
                            const modalEl = form.closest(".modal");
                            if (modalEl) {
                                const modal = bootstrap.Modal.getInstance(modalEl);
                                if (modal) modal.hide();
                                document.body.classList.remove("modal-open");
                                document.querySelectorAll(".modal-backdrop").forEach(el => el.remove());
                            }
                        });
                };

                if (form.id === "chatSearchForm") {
                    const url = form.action + "?" + new URLSearchParams(new FormData(form));
                    loadTabContent("chatContent", url);
                } else if (form.hasAttribute("courses-search")) {
                    const url = form.action + "?" + new URLSearchParams(new FormData(form));
                    loadTabContent("coursesContent", url);
                } else if (form.id === "sendMessageForm") {
                    handleFetch("chatContent");
                } else if (form.hasAttribute("form-courses")) {
                    handleFetch("coursesContent");
                } else if (form.hasAttribute("form-payments")) {
                    handleFetch("paymentsContent");
                } else if (form.hasAttribute("form-refunds")) {
                    handleFetch("refundsContent");
                }
            });
        </script>
}

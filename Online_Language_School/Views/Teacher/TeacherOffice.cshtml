@{
    ViewData["Title"] = "Teacher Office";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid">
    <div class="row">
        <!-- Ліва панель -->
        <nav class="col-2 bg-light border-end"
             style="position:fixed; top:0; left:0; height:100vh; overflow-y:auto; padding:20px;">
            <h5>Menu</h5>
            <ul class="nav flex-column nav-pills">
                <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#schedule">Schedule</a></li>
                <li class="nav-item"><a class="nav-link" href="@Url.Action("Index","Home")">Main page</a></li>
                <li class="nav-item"><a class="nav-link" href="@Url.Action("Index","News")">School news</a></li>
                <li class="nav-item"><a class="nav-link" href="#">Contact the administration</a></li>
            </ul>
            <hr />
            <footer class="small text-center">
                <p>📞 info@languageschool.com | +380 67 123 4567</p>
                <p>🌐 <a href="#">Facebook</a> | <a href="#">Instagram</a> | <a href="#">LinkedIn</a></p>
            </footer>
        </nav>

        <!-- Центральна частина -->
        <main class="col-10 offset-2 p-4">
            <h2 class="mb-4">👨‍🏫 My Office</h2>

            <!-- Вкладки -->
            <ul class="nav nav-tabs" id="teacherTabs" role="tablist">
                <li class="nav-item">
                    <button class="nav-link active" id="schedule-tab" data-bs-toggle="tab" data-bs-target="#schedule" type="button">📅 Schedule</button>
                </li> 
                <li class="nav-item">
                    <button class="nav-link" id="materials-tab" data-bs-toggle="tab" data-bs-target="#materials" type="button">📚 Courses</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="tests-tab" data-bs-toggle="tab" data-bs-target="#tests" type="button">📝 Tests</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" id="chat-tab" data-bs-toggle="tab" data-bs-target="#chat" type="button">💬 Chat</button>
                </li>
            </ul>

            <!-- Контент вкладок -->
            <div class="tab-content mt-3">
                <div class="tab-pane fade show active" id="schedule" role="tabpanel">
                    <div id="scheduleContent">Loading...</div>
                </div>
                <div class="tab-pane fade" id="materials" role="tabpanel">
                    <div id="materialsContent">Loading...</div>
                </div>
                <div class="tab-pane fade" id="tests" role="tabpanel">
                    <div id="testsContent">Loading...</div>
                </div>
                <div class="tab-pane fade" id="chat" role="tabpanel">
                    <div id="chatContent">Loading...</div>
                </div>
            </div>
        </main>
    </div>
</div>

@section Scripts {
    <script>
        function loadTabContent(tabId, url) {
            fetch(url)
                .then(response => response.text())
                .then(html => {
                    document.getElementById(tabId).innerHTML = html;
                });
        }

        // Завантажуємо Schedule при старті
        loadTabContent("scheduleContent", "/Teacher/Schedule");

        // Підвантаження при кліку на вкладки
        document.getElementById("schedule-tab").addEventListener("click", () => {
            loadTabContent("scheduleContent", "/Teacher/Schedule");
        });
        document.getElementById("materials-tab").addEventListener("click", () => {
            loadTabContent("materialsContent", "/Teacher/Courses");
        });
        document.getElementById("tests-tab").addEventListener("click", () => {
            loadTabContent("testsContent", "/Teacher/Tests");
        });
        document.getElementById("chat-tab").addEventListener("click", () => {
            loadTabContent("chatContent", "/Chat/Index");
        });

        document.addEventListener("click", function(e) {
            // якщо клік по accordion‑кнопці — нічого не робимо
            if (e.target.closest(".accordion-button")) {
                return;
            }

            const chatLink = e.target.closest("a[data-chat]");
            const materialsLink = e.target.closest("a[edit-materials]");

            if (chatLink) {
                e.preventDefault();
                const url = chatLink.getAttribute("href");
                loadTabContent("chatContent", url);
            }

            if (materialsLink) {
                e.preventDefault();
                const url = materialsLink.getAttribute("href");
                loadTabContent("materialsContent", url);
            }
        });


        document.addEventListener("submit", e => {
            const form = e.target;
            e.preventDefault();

            const fetchAndUpdate = (contentId) => {
                const formData = new FormData(form);
                fetch(form.action, { method: "POST", body: formData })
                    .then(res => res.text())
                    .then(html => {
                        document.getElementById(contentId).innerHTML = html;
                        const modalEl = form.closest(".modal");
                        if (modalEl) {
                            const modal = bootstrap.Modal.getInstance(modalEl);
                            if (modal) modal.hide();
                            document.body.classList.remove("modal-open");
                            document.querySelectorAll(".modal-backdrop").forEach(el => el.remove());
                        }
                    });
            };

            if (form.id === "chatSearchForm") {
                const url = form.action + "?" + new URLSearchParams(new FormData(form));
                loadTabContent("chatContent", url);
            } else if (form.id === "sendMessageForm") {
                fetchAndUpdate("chatContent");
            } else if (form.hasAttribute("form-materials")) {
                fetchAndUpdate("materialsContent");
            } else if (form.hasAttribute("form-schedule")) {
                fetchAndUpdate("scheduleContent");
            } else if (form.hasAttribute("course-status")) {
                fetchAndUpdate("materialsContent");
            }
        });
    </script>
}
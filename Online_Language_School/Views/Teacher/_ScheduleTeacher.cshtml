@model IEnumerable<Online_Language_School.Models.PlannedLesson>
@using Online_Language_School.Models;

<h4 class="mb-3">📅 Class schedule</h4>

<button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addPlannedLessonModal">
    ➕ Add class
</button>

<!-- MODAL ADD PLANNED LESSON -->
<div class="modal fade" id="addPlannedLessonModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Schedule class</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <form id="planLessonForm" asp-action="ScheduleLesson" asp-controller="Teacher" method="post" form-schedule>

                    <!-- COURSE -->
                    <div class="mb-3">
                        <label class="form-label">Course</label>
                        <select id="courseSelect" name="CourseId" class="form-select" required>
                            <option value="">-- Select course --</option>
                            @foreach (var c in ViewBag.ActiveCourses)
                            {
                                <option value="@c.Id" data-format="@c.Format">
                                    @c.Title (@c.Format)
                                </option>
                            }
                        </select>
                    </div>

                    <!-- LESSON -->
                    <div class="mb-3">
                        <label class="form-label">Lesson</label>
                        <select id="lessonSelect" name="LessonId" class="form-select" required>
                            <option value="">-- First choose a course --</option>
                            @foreach(var l in ViewBag.Lessons) 
                            {
                                <option value="@l.Id">
                                    @l.Title
                                </option>
                            }
                        </select>
                    </div>

                    <!-- STUDENT (ONLY FOR INDIVIDUAL) -->
                    <div class="mb-3 d-none" id="studentBlock">
                        <label class="form-label">Student (only individual course)</label>
                        <select id="studentSelect" name="StudentId" class="form-select">
                            <option value="">-- Choose a student --</option>
                        </select>
                    </div>

                    <!-- DATETIME -->
                    <div class="mb-3">
                        <label class="form-label">Date and time</label>
                        <input name="StartTime" type="datetime-local" class="form-control" required />
                    </div>

                    <button class="btn btn-success">Apply</button>
                </form>
            </div>

        </div>
    </div>
</div>

<!-- LIST OF PLANNED LESSONS -->
<h4 class="mt-4">📚 Planned lessons</h4>
<table class="table table-bordered table-striped">
    <thead class="table-dark">
        <tr>
            <th>Date</th>
            <th>Course</th>
            <th>Format</th>
            <th>Class</th>
            <th>Student</th>
            <th>Duration</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var p in Model)
        {
                <tr>
                    <td>@p.StartTime.ToString("yyyy-MM-dd HH:mm")</td>
                    <td>@p.Lesson?.Course?.Title</td>
                    <td>@p.Lesson?.Course?.Format</td>
                    <td>@p.Lesson?.Title</td>
                        <td>@(p.Student != null
                                ? $"{p.Student.FirstName} {p.Student.LastName}"
                                : (p.Lesson?.Course?.Format == "Group" ? "Група" : "-"))</td>
                    <td>@p.Lesson?.DurationMinutes хв</td>
                    <td>
                        <form asp-action="DeletePlannedLesson" asp-controller="Teacher" method="post" class="d-inline" form-schedule>
                            <input type="hidden" name="id" value="@p.Id" />
                            <button class="btn btn-danger btn-sm">Remove</button>
                        </form>
                    </td>
                </tr>
        }
    </tbody>
</table>

<!-- CALENDAR -->
<h4 class="mb-3">📅 Calendar</h4>

<div class="border p-3 text-center">
    <table class="table table-bordered text-center">
        <thead>
            <tr>
                <th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th>
                <th>Fri</th><th>Sat</th><th>Sun</th>
            </tr>
        </thead>
        <tbody>
            @{
                var now = DateTime.Now;
                var start = new DateTime(now.Year, now.Month, 1);
                var first = (int)start.DayOfWeek; if (first == 0) first = 7;
                var days = DateTime.DaysInMonth(now.Year, now.Month);
                var day = 1;

                for (int r = 0; r < 6; r++)
                {
                    <tr>
                        @for (int c = 1; c <= 7; c++)
                        {
                            if ((r == 0 && c < first) || day > days)
                            {
                                <td></td>
                            }
                            else
                            {
                                var d = new DateTime(now.Year, now.Month, day);
                                var has = Model.Any(x => x.StartTime.Date == d.Date);

                                <td class="@(has ? "bg-success text-white" : "")">@day</td>;
                                day++;
                            }
                        }
                    </tr>
                }
            }
        </tbody>
    </table>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    // Делегований обробник — спрацьовує навіть якщо модалка створюється динамічно
    document.addEventListener("change", async function (e) {
        try {
            const target = e.target;
            if (!target) return;

            // реагуємо лише на зміну саме courseSelect
            if (target.id !== "courseSelect") return;

            const courseId = target.value;
            const selectedOption = target.selectedOptions && target.selectedOptions[0];
            const format = selectedOption ? selectedOption.dataset.format : null;

            // DOM refs
            const lessonSelect = document.getElementById("lessonSelect");
            const studentBlock = document.getElementById("studentBlock");
            const studentSelect = document.getElementById("studentSelect");

            if (!lessonSelect) {
                console.warn("lessonSelect not found in DOM");
                return;
            }

            // Показ/приховування блоку студентів
            if (format === "Individual") {
                if (studentBlock) studentBlock.classList.remove("d-none");
            } else {
                if (studentBlock) studentBlock.classList.add("d-none");
            }

            // Якщо нічого не вибрано — скидаємо select-и
            if (!courseId) {
                lessonSelect.innerHTML = '<option value="">-- First choose a course --</option>';
                if (studentSelect) studentSelect.innerHTML = '<option value="">-- Choose a student --</option>';
                return;
            }

            // Підвантаження уроків
            lessonSelect.innerHTML = '<option>Loading...</option>';
            const lessonsUrl = `/Teacher/GetLessonsByCourse/${encodeURIComponent(courseId)}`;
            const lessonsRes = await fetch(lessonsUrl, { method: 'GET' });

            if (!lessonsRes.ok) {
                console.error("Lessons fetch failed", lessonsRes.status, lessonsRes.statusText);
                lessonSelect.innerHTML = '<option value="">Error loading lessons</option>';
            } else {
                const txt = await lessonsRes.text();

                // Якщо сервер повернув HTML <option> — підставляємо напряму.
                // Якщо сервер повернув JSON масив — перетворимо його у option-и.
                if (txt.trim().startsWith("<")) {
                    lessonSelect.innerHTML = txt;
                } else {
                    // Спроба розпарсити JSON
                    try {
                        const arr = JSON.parse(txt);
                        let html = '<option value="">-- Select lesson --</option>';
                        arr.forEach(l => {
                            html += `<option value="${l.id}">${escapeHtml(l.title)}</option>`;
                        });
                        lessonSelect.innerHTML = html;
                    } catch (jsonErr) {
                        // якщо не JSON — просто вставимо як текст
                        lessonSelect.innerHTML = txt;
                    }
                }
            }

            // Підвантаження студентів для індивідуального курсу
            if (format === "Individual" && studentSelect) {
                studentSelect.innerHTML = '<option>Loading...</option>';
                const studentsUrl = `/Teacher/GetStudentsByCourse/${encodeURIComponent(courseId)}`;
                const studentsRes = await fetch(studentsUrl, { method: 'GET' });

                if (!studentsRes.ok) {
                    console.error("Students fetch failed", studentsRes.status, studentsRes.statusText);
                    studentSelect.innerHTML = '<option value="">Error loading students</option>';
                } else {
                    const txt2 = await studentsRes.text();
                    if (txt2.trim().startsWith("<")) {
                        studentSelect.innerHTML = txt2;
                    } else {
                        try {
                            const arr2 = JSON.parse(txt2);
                            let html2 = '<option value="">-- Select student --</option>';
                            arr2.forEach(s => {
                                html2 += `<option value="${s.id}">${escapeHtml(s.firstName)} ${escapeHtml(s.lastName)}</option>`;
                            });
                            studentSelect.innerHTML = html2;
                        } catch {
                            studentSelect.innerHTML = txt2;
                        }
                    }
                }
            }
        } catch (err) {
            console.error("Error handling course change", err);
        }
    });

    // утиліти
    function escapeHtml(str) {
        if (!str && str !== 0) return "";
        return String(str)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }
});
</script>


